on:
  workflow_call:

permissions: {}

env:
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  CARGO_TERM_COLOR: always
  RUSTUP_MAX_RETRIES: 10

jobs:
  benchmarks-walltime-build:
    name: "walltime build"
    runs-on: depot-ubuntu-22.04-arm-4
    if: ${{ github.repository == 'astral-sh/uv' }}
    timeout-minutes: 20
    steps:
      - name: "Checkout Branch"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: "Install Rust toolchain"
        run: rustup show

      - name: "Install codspeed"
        uses: taiki-e/install-action@d850aa816998e5cf15f67a78c7b933f2a5033f8a # v2.63.3
        with:
          tool: cargo-codspeed

      - name: "Install requirements and prime cache"
        run: |
          sudo apt-get update
          sudo apt-get install -y libsasl2-dev libldap2-dev libkrb5-dev
          cargo run --bin uv -- venv --cache-dir .cache
          # Existing benchmarks
          cargo run --bin uv -- pip compile test/requirements/jupyter.in --universal --exclude-newer 2024-09-01 --cache-dir .cache
          cargo run --bin uv -- pip compile test/requirements/airflow.in --universal --exclude-newer 2024-09-01 --cache-dir .cache
          # Lightweight packages
          echo "ruff>=0.4.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo "black>=24.0.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo "pytest>=8.0.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo "trio>=0.25.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          # Web frameworks
          echo "django>=5.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo -e "fastapi>=0.111.0\nuvicorn[standard]>=0.29.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          # Data science packages
          echo "numpy>=1.26.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo "pandas>=2.2.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo "scipy>=1.13.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo -e "numpy>=1.26.0\npandas>=2.2.0\nscikit-learn>=1.4.0\nmatplotlib>=3.8.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          # Incremental benchmark
          echo -e "trio>=0.25.0\nhttpx>=0.27.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache

      - name: "Build benchmarks"
        run: cargo codspeed build -m walltime --profile profiling -p uv-bench

      - name: "Create artifact archive"
        run: tar -cvf benchmarks-walltime.tar target/codspeed target/debug/uv .cache

      - name: "Upload benchmark artifacts"
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: benchmarks-walltime
          path: benchmarks-walltime.tar
          retention-days: 1

  benchmarks-walltime-run:
    name: "walltime on aarch64 linux"
    runs-on: codspeed-macro
    needs: benchmarks-walltime-build
    timeout-minutes: 20
    steps:
      - name: "Checkout Branch"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: "Install codspeed"
        uses: taiki-e/install-action@d850aa816998e5cf15f67a78c7b933f2a5033f8a # v2.63.3
        with:
          tool: cargo-codspeed

      - name: "Download benchmark artifacts"
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: benchmarks-walltime

      - name: "Extract artifact archive"
        run: tar -xvf benchmarks-walltime.tar

      - name: "Create venv"
        run: ./target/debug/uv venv --cache-dir .cache

      - name: "Run benchmarks"
        uses: CodSpeedHQ/action@346a2d8a8d9d38909abd0bc3d23f773110f076ad # v4.4.1
        with:
          run: cargo codspeed run
          mode: walltime
          token: ${{ secrets.CODSPEED_TOKEN }}

  benchmarks-simulated:
    name: "simulated"
    runs-on: ubuntu-latest
    if: ${{ github.repository == 'astral-sh/uv' }}
    timeout-minutes: 20
    steps:
      - name: "Checkout Branch"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: "Install Rust toolchain"
        run: rustup show

      - name: "Install codspeed"
        uses: taiki-e/install-action@d850aa816998e5cf15f67a78c7b933f2a5033f8a # v2.63.3
        with:
          tool: cargo-codspeed

      - name: "Install requirements and prime cache"
        run: |
          sudo apt-get update
          sudo apt-get install -y libsasl2-dev libldap2-dev libkrb5-dev
          cargo run --bin uv -- venv --cache-dir .cache
          # Existing benchmarks
          cargo run --bin uv -- pip compile test/requirements/jupyter.in --universal --exclude-newer 2024-09-01 --cache-dir .cache
          cargo run --bin uv -- pip compile test/requirements/airflow.in --universal --exclude-newer 2024-09-01 --cache-dir .cache
          # Lightweight packages
          echo "ruff>=0.4.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo "black>=24.0.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo "pytest>=8.0.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo "trio>=0.25.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          # Web frameworks
          echo "django>=5.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo -e "fastapi>=0.111.0\nuvicorn[standard]>=0.29.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          # Data science packages
          echo "numpy>=1.26.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo "pandas>=2.2.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo "scipy>=1.13.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          echo -e "numpy>=1.26.0\npandas>=2.2.0\nscikit-learn>=1.4.0\nmatplotlib>=3.8.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache
          # Incremental benchmark
          echo -e "trio>=0.25.0\nhttpx>=0.27.0" | cargo run --bin uv -- pip compile - --universal --exclude-newer 2024-09-01 --cache-dir .cache

      - name: "Build benchmarks"
        run: cargo codspeed build --profile profiling -p uv-bench

      - name: "Run benchmarks"
        uses: CodSpeedHQ/action@346a2d8a8d9d38909abd0bc3d23f773110f076ad # v4.4.1
        with:
          run: cargo codspeed run
          mode: simulation
          token: ${{ secrets.CODSPEED_TOKEN }}
